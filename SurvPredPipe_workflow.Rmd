---
title: " Introduction to the Workflow of SurvPredPipe"
author: "Harpreet Kaur (harpreet.kaur2@nih.gov, hks04180@gmail.com)"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{SurvPredPipe_vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Load
```{r setup}
library(SurvPredPipe)
```

WorkFlow
```{r setup}
#Load package
library(SurvPredPipe)

#Load other required packages
library(caret)
library(preprocessCore)
library(ggfortify)
library(survival)
library(survminer)
library(dplyr)
library(ggplot2)
library(ggfortify)
library(MASS)
library(MTLR)
library(dplyr)
library(SurvMetrics)
library(pec)
library(glmnet)
library(reshape2)
library(rms)
library(Matrix)
library(Hmisc)
library(survivalROC)
library(ROCR)

#set seed
set.seed(7)
```


#set path of the working directory where input data available
# Input Data
Example Input data: "Example_TCGA_LGG_FPKM_data.txt" is a tab separated file.  It contains Samples (184 LGG Cancer Samples) in the rows and Features in the columns. Gene Expression is available in terms of FPKM values in the data.
Features information: In the data there are 11 clinical + demographic, 4 types survival with time and event information  and 19,978 protein coding genes.
Clinical and demographic features: Clinical demographic features that are present in this example data include Age,  subtype,  gender,  race,  ajcc_pathologic_tumor_stage,  histological_type, histological_grade,  treatment_outcome_first_course, radiation_treatment_adjuvant,  sample_type,  type.
Types of Survival: 4 types of Survival include OS (overall survival), PFS (progression-free survival), DSS (disease-specific survival), DFS (Disease-free survival). In the data, column names OS, PFS, DSS and DFS represent event information, while  OS.time, PFS.time, DSS.time and DFS.time indicate survival time in days.

Step 1- Data Processing: This function converts OS time (in days) into months and then removes samples where OS/OS.time information is missing. Here, we need to provide input data in tsv or txt  format. Further, we needs to define col_num (column number at which clinical/demographic and survival information ends, e.g. 20, and output file name, e.g.  “New_data.txt”

```{r setup}
#Data Processing:  
SurvPredPipe::data_process_f(data="TCGA-LGG_protein_coding_FPKM_data_with_clin_data.txt",col_num=20, output="New_data.txt") 
```

After data processing, we got a new output file “New_data.txt”, which contains 176 samples. Thus, data_process_f function removes 8 samples where OS/OS time information is missing. Besides, here is a new 21st column in the data with  column name “OS_month”  where OS time is available in months.


Step 2 - Split Data into Training and Test Subset: Before proceeding further, we need to split our data into training and test subset for the purpose of feature selection and model development. Here, we need output from the previous step as an input ( which was “New_data.txt”). Next we need to define the fraction (e.g. 0.9) by which we want to split data into training and test. Thus, fraction=0.9 will split data into 90% training and 10% as test set. Besides, we also need to provide training and set output names (e.g. train_FPKM.txt,test_FPKM.txt )


```{r setup}
# Split Data into Training and Test subset
SurvPredPipe::tr_test_f(data="New_data.txt",fraction=0.9, train_data="train_FPKM.txt", test_data="test_FPKM.txt")
```


After the train-test split, we got a two new outputs:  “train_FPKM.txt”, “test_FPKM.txt”, where, train_FPKM.txt contains 158 samples and test_FPKM.txt contains 18 samples. Thus, tr_test_f function splits data into 90:10 ratio. 

Step 3 - Data Normalization: Next to select features and develop ML models, data must be normalized. Since, expression is available in terms of FPKM values. Thus,  `train_test_normalization_f` function will first convert FPKM value into log scale [log2(FPKM+1) followed by quantile normalization using the “preprocessCore” package. Here, training data will be used as a target matrix for quantile normalization.  Here, we need to provide training and test datasets (that we obtained from the  previous step of Train/Test Split). Further, we need to provide column number where clinical information ends (e.g. 21) in the input datasets. Besides, we also need to provide output files names (train_clin_data (which contains only Clinical information of training data), test_clin_data (which contains only Clinical information of training data), train_Normalized_data_clin_data (which contains Clinical information and normalized values of genes of training samples), test_Normalized_data_clin_data (which contains Clinical information and normalized values of genes of test samples).


```{r setup}
# Data Normalization
SurvPredPipe::train_test_normalization_f(train_data="train_FPKM.txt",test_data="test_FPKM.txt", col_num=21, train_clin_data="Train_Clin.txt", test_clin_data="TestClin.txt", train_Normalized_data_clin_data="Train_Norm_data.txt", test_Normalized_data_clin_data="Test_Norm_data.txt")
```

After, running the function, we obtained 4 outputs: Train_Clin.txt - Contains only Clinical features, Test_Clin.txt- contains only Clinical features of Test samples;  Train_Norm_data.txt- Clinical features with normalized values of genes for training samples; Test_Norm_data.txt - Clinical features with normalized values of genes for test samples.


Step 4a - Prognostic Index (PI)  Score Calculation:
Next to create a survival model, we  will  create a Prognostic Index (PI)  Score. PI score is calculated based on the expression of the features selected by the LASSO regression model and their beta coefficients. For instance, 5 features  (G1, G2, G3, G4, and G5 and their coefficient values are B1, B2, B3, B4, and B5, respectively) selected by the LASSO method. Then PI score will be computed as following:

PI score  = G1*B1 + G2*B2 + G3 * B3 + G4*B4+ G5*B5

Here, we need to provide Normalized training (Train_Norm_data.txt) and test data (Test_Norm_data.txt)as input data that we have obtained from the previous function “train_test_normalization_f”. Further, we need to provide col_num n column number at which clinical features ends (e.g. 21), nfolds  (number of folds  e.g. 5) for the LASSO regression method to select features. We implemented LASSO using the “glmnet” package. Besides, we also need to provide names and training and test output file names to store data containing LASSO genes and PI values. 



```{r setup}
# Feature Selection using LASSO Regression and Prognostic Index (PI)  Score Calculation
SurvPredPipe::Lasso_PI_scores_f(train_data="Train_Norm_data.txt",test_data="Test_Norm_data.txt", nfolds=5, col_num=21, train_PI_data="Train_PI_data.txt", test_PI_data="Test_PI_data.txt" )
```

Thus, Lasso_PI_scores_f gave us following outputs:
1. Train_Lasso_key_variables.txt: List of features selected by LASSO and their beta coefficient values
2. Train_Cox_Lasso_Regression_lamda_plot.jpeg: Lasso Regression Lambda plot.
3. Train_PI_data.txt: It contains expression of genes selected by LASSO and PI score in the last column for training samples.
4. Test_PI_data.txt: It contains expression of genes selected by LASSO and PI score in the last column for test samples.


Step 4b - Univariate  Survival Significant Feature Selection:
Besides PI score, with the “Univariate_sig_features_f” function of SurvPredPipe package, we can select significant (p-value <0.05) features based on univariate survival analysis. These features are selected based on their capability to stratify high-risk and low-risk survival groups using the cut off value of their median expression.  
Here, we need to provide Normalized training (Train_Norm_data.txt) and test data (Test_Norm_data.txt)as input data that we have obtained from the previous function “train_test_normalization_f”. Further, we need to provide a “col_num” (e.g 21)column number at which clinical features ends. Besides, we also need to provide names and training and test output file names to store data containing expression of selected genes.


```{r setup}
# Feature selection using Univariate Survival Analysis
`SurvPredPipe::Univariate_sig_features_f(train_data="Train_Norm_data.txt", test_data="Test_Norm_data.txt", col_num=21, output_univariate_train="Train_Uni_sig_data.txt", output_univariate_test="Test_Uni_sig_data.txt")
```

Thus, Univariate_sig_features_f  gave us following outputs:
Univariate_Survival_Significant_genes_List.txt: a table of univariate significant genes along with their corresponding coefficient values, HR value, P-values, C-Index values.
Train_Uni_sig_data.txt: It contains expression of significant genes selected by univariate survival analysis for training samples.
Test_Uni_sig_data.txt: It contains expression of significant genes selected by univariate survival analysis for test samples.

Step 5 - Prediction model development for survival probability of patients
After selecting significant or key features using LASSO or Univariate survival analysis, next we want to develop an ML prediction model to predict survival probability of patients. MTLR_pred_model_f function of SurvPredPipe give us multiple options to develop models including Only Clinical features (Model_type=1), PI score (Model_type=2), PI Score + Clinical features (Model_type=3), Significant Univariate features (Model_type=4), Significant Univariate features Clinical features (Model_type=5) using MTLR package. Further, here, we were interested in developing a model based on PI score. Thus, we need to provide following inputs: (1) Training data with only clinical features, (2) Test data with only clinical features, (3) Model type (e.g. 2, since we want to develop model based on PI score), (4) Training data with PI score , (5) Test data with PI score, (6) Clin_Feature_List (e.g. Key_PI_list.txt), a list of features which will be  used to build model.

```{r setup}
# Survival Model Development and Prediction of Survival, survival probability for Individual Patients using Selected Features employing MTLR
# Model for only Clinical features
SurvPredPipe::MTLR_pred_model_f(train_clin_data = "Train_Clin.txt", test_clin_data = "Test_Clin.txt", Model_type = 1, train_features_data = "Train_Clin.txt", test_features_data = "Test_Clin.txt" , Clin_Feature_List="Key_Clin_feature_list.txt")

# Model for PI
SurvPredPipe::MTLR_pred_model_f(train_clin_data = "Train_Clin.txt", test_clin_data = "Test_Clin.txt", Model_type = 2, train_features_data = "Train_PI_data.txt", test_features_data = "Test_PI_data.txt" , Clin_Feature_List="Key_PI_list.txt")

# Model for Clinical features + PI
SurvPredPipe::MTLR_pred_model_f(train_clin_data = "Train_Clin.txt", test_clin_data = "Test_Clin.txt", Model_type = 3, train_features_data = "Train_PI_data.txt", test_features_data = "Test_PI_data.txt" , Clin_Feature_List="Key_Clin_features_with_PI_list.txt")

# Model for univariate features
SurvPredPipe::MTLR_pred_model_f(train_clin_data = "Train_Clin.txt", test_clin_data = "Test_Clin.txt", Model_type = 4, train_features_data = "Train_Uni_sig_data.txt", test_features_data = "Test_Uni_sig_data.txt" , Clin_Feature_List="Key_univariate_features_list.txt")

# Model for Univariate + Clinical features
SurvPredPipe::MTLR_pred_model_f(train_clin_data = "Train_Clin.txt", test_clin_data = "Test_Clin.txt", Model_type = 5, train_features_data = "Train_Uni_sig_data.txt", test_features_data = "Test_Uni_sig_data.txt" , Clin_Feature_List="Key_univariate_features_with_Clin_list.txt")

```

After, implementing MTLR_pred_model_f function , we got following outputs:
1. Model_with_PI.RData : Model on training data
2. survCurves_data.txt: Table containing predicted survival probability of each patient at different time points. This data can be further used to plot the survival curve of patients.
3. mean_median_survival_time_data.txt: Table containing predicted mean and median survival time  of each patient in the test data. This data can be further used for bar plots.
4. Error_mat_for_Model.txt: Table containing performance parameters obtained on test data based on prediction model. It contains IBS score (Integrated Brier Score) =0.192, C-Index =0.81.


Step 6 - Survival curves/plots for individual patient
Next to visualize survival of patients, we will plot survival curve plots using the surv_curve_plots_f function  based on the data “survCurves_data.txt” that we obtained from the previous step after running the  MTLR_pred_model_f function. Further,  the surv_curve_plots_f function also allows highlighting a specific patient on the curve. Thus the function  needs only two inputs: 1) Surv_curve_data, (2) Sample ID of a specific patient (e.g. TCGA-TQ-A8XE-01) that needs to be highlighted.


```{r setup}
#Create Survival curves/plots for individual patients
SurvPredPipe::surv_curve_plots_f(Surv_curve_data="survCurves_data.txt", selected_sample="TCGA-TQ-A8XE-01")
```

Here, we obtained two output plots:
1. Survival curves for all patients in the test data with different colors 
2. Survival curves for all patients (in black) and highlighted patient (yellow) in the test data 



Step 7 - Bar Plot for predicted  mean and median survival time of individual patients
Next to visualize predicted survival time of patients, we will plot barplot for mean/median using “mean_median_surv_barplot_f” function based on the data that we obtained from step 5 after running the  MTLR_pred_model_f function. Further,  the mean_median_surv_barplot_f function also allows highlighting a specific patient on the curve. Thus the function  needs only two inputs: 1) surv_mean_med_data, (2) Sample ID of a specific patient (e.g. TCGA-TQ-A8XE-01) that needs to be highlighted.


```{r setup}
#Create Bar Plot for predicted  mean and median survival time of individual patients
SurvPredPipe::mean_median_surv_barplot_f(surv_mean_med_data="mean_median_survival_time_data.txt", selected_sample="TCGA-TQ-A8XE-01")
```
Here, we obtained two output plots:
1. Barplot for all patients in the test data, where the red color bar represents mean survival and cyan/green color bar represents median survival time. 
2. Barplot for all patients with a highlighted patient (dashed black outline) in the test data. It shows  this patient has a predicted mean and median survival is 81.58 and 75.50 months.



Step 8- Nomogram based on Key features
Next, the Nomogram_generate_f function of SurvPredPipe  also provides an option to generate a nomogram plot based on user defined clinical and other features in the data. For instance, we will generate a nomogram based on 6 features (Age, gender, race, histological_type, sample_type, PI). Here, we will provide data containing all the features (Samples in rows and features in columns) (e.g. Train_Data_Nomogram_input.txt) and a list of features (feature_list_for_Nomogram.txt) based on which we want to generate a nomogram.

```{r setup}
#Create Nomogram based on Key features
SurvPredPipe::Nomogram_generate_f(data="Train_Data_Nomogram_input.txt",  Feature_List="feature_list_for_Nomogram.txt")
```

Here, we will get a Nomogram based on features that we provide. This nomogram can predict Risk (Event risk, eg, Death), 1-year, 3-year, 5-year and 10 years survival of patients.

